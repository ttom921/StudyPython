<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- This is the bundle generated by rollup.js -->
    <script src="index.js"></script>
</head>

<body>
    <h2>file list</h2>
    <ul>

    </ul>
    <hr />
    <h2>Python Flask File(s) Upload - Select file(s) to upload</h2>
    <dl>
        <p>
            <p id="msg"></p>
            <input type="file" id="multiFiles" />
            <button id="upload">Upload</button>
        </p>
    </dl>

    <!-- <dl>
        <p>
            <p id="msg"></p>
            <input type="file" id="multiFiles" name="files[]" multiple="multiple" />
            <button id="upload">Upload</button>
        </p>
    </dl> -->




    <script>
        let m = monitor.getInstance();
        m.init('aaaaaa');
        //console.log(m);
        m.init('cccc');
        monitor.getInstance().showAppid();
        let n = monitor.getInstance();
        console.log(m === n);
        //m.getAjaxTest();
        m.getFilelist((res) => {
            //console.log("filelist=>" + res);
            res.forEach(element => {
                console.log("element=>" + element);
                $("ul").append(`<li>${element} <button onclick="filedownload('${element}')">下載</button></li>`)
            });
        });
        //下載
        function filedownload(params) {
            console.log(params);
            m.download(params, (response) => {
                console.log(response);
                let blob = new Blob([response.data]);
                if (window.navigator.msSaveOrOpenBlob) {
                    console.log("aaaa");
                    navigator.msSaveBlob(blob, params);
                } else {
                    console.log("bbbb");
                    let link = document.createElement("a");
                    let evt = document.createEvent("HTMLEvents");
                    evt.initEvent("click", false, false);
                    link.href = URL.createObjectURL(blob);
                    link.download = params;
                    link.style.display = "none";
                    document.body.appendChild(link);
                    link.click();
                    window.URL.revokeObjectURL(link.href);
                }
            });
        }
        $(document).ready(function (e) {
            console.log("ready");
            $('#upload').on('click', function () {
                let form_data = new FormData();
                //let file_data = document.getElementById('file');
                var file_data = $('#multiFiles').prop('files')[0];   //取得上傳檔案屬性
                // console.log(file_data);
                if (file_data == null) {
                    $('#msg').html('<span style="color:red">Select at least one file</span>');
                    return;
                }
                console.log(file_data);
                //let ins = document.getElementById('file').files.length;
                // if (ins == 0) {
                //     $('#msg').html('<span style="color:red">Select at least one file</span>');
                //     return;
                // }
                form_data.append('files', file_data);  //把物件加到file後面
                //m.upload(form_data, onUploadProgress);
                m.upload(form_data);
            })

        });
        function onUploadProgress(params) {
            console.log(params);
        }

        // $(document).ready(function (e) {
        //     $('#upload').on('click', function () {
        //         var form_data = new FormData();

        //         var file_data = $('#multiFiles').prop('files')[0];   //取得上傳檔案屬性
        //         //console.log(file_data);
        //         if (file_data == null) {
        //             $('#msg').html('<span style="color:red">Select at least one file</span>');
        //             return;
        //         }
        //         console.log(file_data);
        //         form_data.append('files', file_data);  //吧物件加到file後面
        //         // var ins = document.getElementById('multiFiles').files.length;

        //         // if (ins == 0) {
        //         //     $('#msg').html('<span style="color:red">Select at least one file</span>');
        //         //     return;
        //         // }

        //         // for (var x = 0; x < ins; x++) {
        //         //     form_data.append("files", document.getElementById('multiFiles').files[x]);
        //         // }
        //         $.ajax({
        //             url: 'http://127.0.0.1:5000/file-upload', // point to server-side URL
        //             dataType: 'json', // what to expect back from server
        //             cache: false,
        //             contentType: false,
        //             processData: false,
        //             data: form_data,
        //             type: 'post',
        //             success: function (response) { // display success response
        //                 $('#msg').html('');
        //                 $.each(response, function (key, data) {
        //                     if (key !== 'message') {
        //                         $('#msg').append(key + ' -> ' + data + '<br/>');
        //                     } else {
        //                         $('#msg').append(data + '<br/>');
        //                     }
        //                 })
        //             },
        //             error: function (response) {
        //                 $('#msg').html(response.message); // display error response
        //             }
        //         });
        //     });
        // });
        var saveData = (function () {
            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            return function (data, fileName) {
                var json = JSON.stringify(data),
                    blob = new Blob([json], { type: "octet/stream" }),
                    url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = fileName;
                a.click();
                window.URL.revokeObjectURL(url);
            };
        }());
    </script>
</body>

</html>